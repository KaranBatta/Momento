@using Momento.V1.Models
@model Momento.V1.Models.Memories

@{
    ViewBag.Title = "Home Page";
}
<style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
</style>

<div id='map'></div>
<script>
    //Initialize the Mapbox Tiles layer
    var mapboxTiles = L.tileLayer('https://{s}.tiles.mapbox.com/v3/examples.map-zr0njcqy/{z}/{x}/{y}.png');
    var map = L.map('map').addLayer(mapboxTiles);
    
    //Find the users location to get the initial position of the map
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(locationSuccess, locationFail);
    } else {
        alert("Geolocation is not currently supported in your bowser so we cannot find the nearest moments for you");
    }
    
    function locationSuccess(position)
    {
        map.setView([position.coords.latitude, position.coords.longitude], 13);
    }
    
    //set the initial location to San Francisco if Geoposition failed and alert the user
    function locationFail(geoPositionError) {
        map.setView([37, -122], 13);
        alert(geoPositionError);
    }

    //Seperate the double and single click
    var clickCount = 0;

    map.addEventListener('click', function (e) {
        clickCount++;
        if (clickCount === 1) {
            singleClickTimer = setTimeout(function() {
                clickCount = 0;
                singleClick(e);
            },700);
        } else if (clickCount === 2) {
            clearTimeout(singleClickTimer);
            clickCount = 0;
            doubleClick(e);
        }
    }, false);
    
    //When Single Click happens on the map, add a new Marker
    function singleClick(e) {
        var popupTemplate = '<form action="@Url.Action("AddMemory","Home")">Memory: ' +
            '                   @Html.TextBoxFor(m => m.MemoryList[0].Name, new {placeholder = "memory name..", type = "text"})' +
            '                   <br>Description: ' +
            '                   @Html.TextBoxFor(m => m.MemoryList[0].Description, new {placeholder = "memory description..", type = "text"})' +
            '                   <br>Tags (comma seperated):' +
            '                   @Html.TextBoxFor(m => m.MemoryList[0].Tags)' +
            '                   <br>' +
            '                   <input type="submit" value="Submit">' +
            '               </form>';
        var marker = L.marker([e.latlng.lat, e.latlng.lng],
            { draggable: false },
            { clickable: true },
            { title: 'title' },
            { alt: 'alt' },
            { riseOnHover: true }).addTo(map);
        marker.bindPopup(popupTemplate).openPopup();
        map.setView(e.latlng, map.getZoom());
    }
    
    //When Double Click happens zoom in and center to the clicked region
    function doubleClick(e) {
        map.setView(e.latlng, map.getZoom() + 1);
    }
</script>